<html>
<head>
	<meta charset="UTF-8">
	<script src="./echarts.min.js"></script>
	<script src="./jquery-3.2.1.min.js"></script>
	<script src="./data.js"></script>
</head>

<body style="width: 100%;height:100%;">
<div>

<div id="setting">
	<div style="float: left;">
        <input type="file" id="file" onchange="handleFiles(this.files)"/>
		<!-- <div style="float: left;">合约代码</div>
		<input type="text" id="contractcode" value="pb1707" style="float: left;"> -->
	</div>
	<div style="float: left;">
		<div style="float: left;">CompTheo</div>
		<select id="movingTheo" style="float: left;">
		<option value="MA">MA</option>
		<option value="EMA">EMA</option>
		</select>
	</div>
	<div style="float: left;">
		<div style="float: left;">CompXave</div>
		<input style="float: left;"type="text" id="CompXave" value="60">
	</div>
	<div style="float: left;">
		<div style="float: left;">SD</div>
		<input style="float: left;" type="text" id="SD" value="0.5,1,2,3">
	</div>
	<div style="float: left;">
		<button type="button" onclick="startdraw()">draw</button>
	</div>
</div>
<br>
<br>
<br>
<br>

<div id="drawing" style="width: 3000px;height:100%;"></div>


<script type="text/javascript">

        // 首先定义几个颜色的标准：
        // 开多的话，用红五角星。
        // 开空的话，用绿五角星。
        // 撤单的时候，统一用emptypin形状，就是冒泡的形状颜色是橘黄色。
        // 平仓的时候用心型，空的。
        mddata =''
        var myChart = echarts.init(document.getElementById('drawing'));

        data =[]
        time = []
        MIN=200000
        MAX=0
        for (var i = 0; i < datatotal.length; i++) {
            // console.log(datatotal[i])
            tmp = datatotal[i].split(",")
            time.push(tmp[0])
            data.push(Number(tmp[1]))
            if (Number(tmp[1])-50<MIN) {
                MIN = Number(tmp[1])-50
            }
            if (Number(tmp[1])+50>MAX) {
                MAX =Number(tmp[1])+50
            }

        }

        option = {
            toolbox: {
                show : true,
                feature : {
                    mark : {show: true},
                    dataView : {show: true, readOnly: false},
                    magicType : {show: true, type: ['line', 'bar']},
                    restore : {show: true},
                    saveAsImage : {show: true}
                }
            },
            tooltip : {
                trigger: 'axis'
            },
            title: {
                text: 'bollinger band'
            },
            legend: {
                // data:['邮件营销','联盟广告','视频广告','直接访问','搜索引擎']
            },
            xAxis: {
                type: 'category',
                // data: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"]
            },
            yAxis: {
                min:MIN,
                max:MAX,
                type: 'value'
            },         
        };



        // 根据input的file标签读取出相对应的csv的数据。
        // 首先有一个问题就是因为是针对一个合约的数据，所以不存在对其的问题，那么数据还需不需要补充。
        // 如果数据库中的数据，就是接受到的行情的本身的数据，那么就不需要补充，直接去除非交易时间的，直接用就可以了。
        // 补充的话，还会影响最后的效果。
        function  handleFiles(files)
        {
          if(files.length)
          {
             var file = files[0];
             var reader = new FileReader();
             reader.onload = function()
             {
                 // document.getElementById("filecontent").innerHTML = this.result;
                 // console.log(this.result)
                 var data = this.result
                 mddata = data.split("\n")
             };
             reader.readAsText(file);
          }
        }

        function getMAData(dataArray,CompXave) {
        	ret = []
        	var len = dataArray.length
        	for (var i = 0; i <len; i++) {
        		if (i<CompXave-1) {
        			ret.push(dataArray[i])
        		}
        		else{
        			tmp = 0
        			for (var j = CompXave; j > 0; j--) {
        				tmp = tmp + dataArray[i-(CompXave-j)]
        			}
        			ret.push(tmp/CompXave)
        		}
        	}

            for (var i = 0; i < ret.length; i++) {
                ret[i] = Number(ret[i].toFixed(2))
            }
        	return ret

        }


        function getSDdata(dataArray,CompXave){
        	var len = dataArray.length
            var ret = [0]
            var n=1
            for (var i = 1; i < len; i++) {
                if (i<CompXave) {
                    n = i+1
                }
                sum =0
                for (var j = n; j>0; j--) {
                    sum = sum+dataArray[i-(n-j)]
                }
                avg = sum/n
                tmp = 0
                for (var j = n; j>0; j--) {
                    num = dataArray[i-(n-j)]
                    tmp = tmp+(num - avg)*(num - avg)
                }
                ret.push(Math.sqrt(tmp/n))
            }

            for (var i = 0; i < ret.length; i++) {
                ret[i] = Number(ret[i].toFixed(2))
            }
            return ret
        }

        // 这个是真实的值，但是此方法的时间复杂度有点高，就是计算有点复杂。
        function getemadata2(dataArray,CompXave){
        	var len = dataArray.length
        	var n=1
        	var ret = [dataArray[0]]
        	for (var i = 1; i < len; i++) {
        		if (i<CompXave) {
        			n = i+1
        		}
        		tmp = 0
        		for (var j = n; j>0; j--) {
        			tmp = tmp+j*dataArray[i-(n-j)]
        		}
        		ret.push(2*tmp/(n*(n+1)))
        	}
        	return ret
        }

        // 按照公式的计算方法，但是因为是有小数的，小数的四舍五入会影响结果。
        function getEMAData(dataArray,CompXave){
        	var len = dataArray.length
        	var n =1
        	var ret =[dataArray[0]]
        	for (var i = 1; i < len; i++) {
        		if (i<CompXave) {
        			n = i+1
        		}
        		var tmpdata = ((n-1)*ret[i-1]+2*dataArray[i])/(n+1)
        		ret.push(tmpdata)
        	}
        	// console.log(n)
            for (var i = 0; i < ret.length; i++) {
                ret[i] = Number(ret[i].toFixed(2))
            }
        	return ret
        }

        function startdraw() {
            // console.log(mddata)
        	var contractcode = $('#contractcode').val()
        	var movingTheo = $('#movingTheo').val()
        	var CompXave = $('#CompXave').val()
        	var SD = $('#SD').val()
            //注意，因为输入的是分钟数，所以在算tick的时候，需要乘以120
            CompXaveNum =  Number(CompXave)*120
            //刚开始计算中间的m线，如果时ma就是按照ma的计算，如果时ema，就按照ema的计算。
            var madata
            if (movingTheo =="MA") {
                madata = getMAData(data,CompXaveNum)
            }
            else{
                madata = getEMAData(data,CompXaveNum)
            }
            sddata = getSDdata(data,CompXaveNum)
            lines = SD.split(',')

            // 根据输入的时间，来重新计算数据，因为输入的时间之前的数据都是没用的，我们需要清理掉，从输入的时间开始画图。
            tmptime = []
            tmpmadata = []
            tmpsddata = []
            for (var i = CompXaveNum-1; i < time.length; i++) {
            	tmptime.push(time[i]) 
            	tmpmadata.push(madata[i])
            	tmpsddata.push(sddata[i])
            }
            madata = tmpmadata
            sddata = tmpsddata
            time = tmptime

            // 设置横坐标的数据
            option.xAxis.data = time

            //设置线条的具体的数据，是一个数组，数组里面是一个一个的对象。
            seriesdata = []
            // 设置总共有多少条线，然后进行命名
            legendata = []

            legendata.push("lastprice")
            legendata.push("ma")
            tmpobj = {}
            tmpobj.name = "ma"
            tmpobj.type = "line"
            tmpobj.data = madata
            seriesdata.push(tmpobj)

            tmpobjlastprice = {}
            tmpobjlastprice.name = "lastprice"
            tmpobjlastprice.type = "line"
            tmpobjlastprice.data = data
            seriesdata.push(tmpobjlastprice)

            // console.log(lines)
            for (var i = 0; i < lines.length; i++) {
                linenum = Number(lines[i])
                legendata.push('+'+lines[i])
                // 设置这一条线的具体的数据
                tmpobj = {}
                tmpobj.name= '+'+lines[i]
                tmpobj.type = "line"
                adddata = []
                for (var j = 0; j < madata.length; j++) {
                    adddata.push(madata[j] + linenum*sddata[j]) 
                }
                tmpobj.data =adddata
                seriesdata.push(tmpobj)

                legendata.push('-'+lines[i]) 
                tmpobjreduce = {}
                tmpobjreduce.name= '-'+[i]
                tmpobjreduce.type = "line"
                adddatareduce = []
                for (var j = 0; j < madata.length; j++) {
                    adddatareduce.push(madata[j] - linenum*sddata[j]) 
                }
                tmpobjreduce.data =adddatareduce
                seriesdata.push(tmpobjreduce)
                if (i==lines.length-1) {
                    for (var i = 0; i < adddata.length; i++) {
                        if (MAX<adddata[i]) {
                            MAX = adddata[i]
                        }
                    }
                    for (var i = 0; i < adddatareduce.length; i++) {
                        if (MIN>adddatareduce[i]) {
                            MIN = adddatareduce[i]
                        }
                    }
                }
            }


            option.legend.data = legendata
            option.series = seriesdata

            option.yAxis.min = MIN
            option.yAxis.max = MAX
            console.log(option)

            myChart.setOption(option);

        }


        myChart.setOption(option);

         // 使用刚指定的配置项和数据显示图表。
         
</script>

</div>

</body>
</html>
